<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>V√©rification des TEG</title>
    {% load static %}
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="{% static 'image/Congo.png' %}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .dashboard {
            margin: 0 auto;
            max-width: 1400px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.15);
            overflow: hidden;
            margin-bottom: 30px;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 20px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: space-between;
            min-height: 120px;
        }

        .header-center {
            text-align: center;
            flex: 1;
            padding: 0 20px;
        }

        .main-title {
            font-size: 1.6em;
            font-weight: bold;
            color: #ffffff;
            margin-bottom: 8px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .separator {
            width: 30%;
            height: 3px;
            background: #efce13;
            margin: 6px auto;
            border: none;
            border-radius: 2px;
        }

        .sub-title {
            font-size: 1.1em;
            color: #efce13;
            font-weight: 600;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }

        .logo-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100px;
        }

        .logo-left {
            margin-right: auto;
        }

        .logo-right {
            margin-left: auto;
        }

        .header-image {
            height: 100px;
            width: auto;
            object-fit: contain;
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1));
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .container {
            max-width: 1400px;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-top: 20px;
        }

        .container h1 {
            color: #2c3e50;
            font-size: 2em;
            font-weight: 700;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 3px solid #efce13;
        }

        .btn-primary {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            border: none;
            padding: 12px 30px;
            font-weight: 600;
            border-radius: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(44, 62, 80, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(44, 62, 80, 0.4);
            background: linear-gradient(135deg, #34495e, #2c3e50);
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745, #20c997);
            border: none;
            padding: 12px 30px;
            font-weight: 600;
            border-radius: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
            background: linear-gradient(135deg, #20c997, #28a745);
        }

        .btn-success:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .alert {
            border-radius: 10px;
            border: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 25px;
        }

        .alert-warning {
            background: linear-gradient(135deg, #fff3cd, #ffe69c);
            color: #856404;
        }

        .alert-warning h4 {
            color: #856404;
            font-weight: 700;
            margin-bottom: 15px;
        }

        .alert-info {
            background: linear-gradient(135deg, #d1ecf1, #bee5eb);
            color: #0c5460;
            font-weight: 500;
        }

        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }

        .stats-card h3 {
            font-size: 1.5em;
            font-weight: 700;
            margin-bottom: 20px;
            border-bottom: 2px solid rgba(255,255,255,0.3);
            padding-bottom: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stat-item {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .stat-item .stat-value {
            font-size: 2em;
            font-weight: 700;
            display: block;
            margin-bottom: 5px;
        }

        .stat-item .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .global-chart-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .global-chart-container h3 {
            color: #2c3e50;
            font-size: 1.4em;
            font-weight: 700;
            margin-bottom: 20px;
            text-align: center;
        }

        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            overflow: hidden;
            height: 100%;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 35px rgba(0,0,0,0.15);
        }

        .card-body {
            padding: 25px;
        }

        .card-title {
            color: #2c3e50;
            font-size: 1.2em;
            font-weight: 700;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }

        .chart-container {
            position: relative;
            height: 250px;
            margin-bottom: 15px;
        }

        .global-chart {
            position: relative;
            height: 350px;
            margin: 20px auto;
            max-width: 500px;
        }

        .badge {
            padding: 8px 15px;
            font-size: 0.95em;
            font-weight: 600;
            border-radius: 6px;
            margin: 5px 0;
            display: inline-block;
        }

        .badge.bg-success {
            background: linear-gradient(135deg, #28a745, #20c997) !important;
            box-shadow: 0 3px 10px rgba(40, 167, 69, 0.3);
        }

        .badge.bg-danger {
            background: linear-gradient(135deg, #dc3545, #c82333) !important;
            box-shadow: 0 3px 10px rgba(220, 53, 69, 0.3);
        }

        .stats-summary {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .row {
            margin-top: 20px;
        }

        .col-md-6, .col-lg-4 {
            margin-bottom: 25px;
        }

        .conformity-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 20px 0;
        }

        .conformity-bar {
            width: 100%;
            height: 30px;
            background: #f0f0f0;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }

        .conformity-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .card, .stats-card, .global-chart-container {
            animation: fadeInUp 0.6s ease-out;
        }

        /* Loading spinner pour le PDF */
        .spinner-border-sm {
            width: 1rem;
            height: 1rem;
            border-width: 0.2em;
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                padding: 15px;
            }

            .logo-container {
                margin: 10px 0;
            }

            .header-image {
                height: 70px;
            }

            .main-title {
                font-size: 1.2em;
            }

            .sub-title {
                font-size: 0.95em;
            }

            .container h1 {
                font-size: 1.5em;
            }

            .chart-container {
                height: 200px;
            }

            .global-chart {
                height: 250px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .action-buttons {
                flex-direction: column;
            }

            .action-buttons .btn {
                width: 100%;
            }
        }

        .alert ul {
            margin: 0;
            padding-left: 20px;
        }

        .alert ul li {
            margin: 8px 0;
            font-weight: 500;
        }
    </style>
</head>

<body>
    <div class="dashboard">
        <div class="header">
            <div class="logo-container logo-left">
                <img src="{% static 'image/Congo.png' %}" alt="R√©publique du Congo" class="header-image">
            </div>

            <div class="header-center">
                <div class="main-title">Comit√© National √âconomique et Financier<br> (CNEF)</div>
                <hr class="separator">
                <div class="sub-title">Banque des Etats de l'Afrique Centrale<br> (BEAC)</div>
            </div>

            <div class="logo-container logo-right">
                <img src="{% static 'image/BEAC.png' %}" alt="BEAC" class="header-image">
            </div>
        </div>
    </div>

    <div class="action-buttons">
        <a href="{% url 'detail_soumission' fichier_id=fichier.id %}" class="btn btn-primary">
            <i class="bi bi-arrow-left"></i> Retour
        </a>
        {% if has_data %}
        <button id="downloadPdfBtn" class="btn btn-success">
            <i class="bi bi-file-earmark-pdf"></i> T√©l√©charger le rapport PDF
            <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
        </button>
        {% endif %}
    </div>

    <div class="container mt-4" id="reportContent">
        <h1>{{ title }}</h1>
        
        {% if erreurs %}
            <div class="alert alert-warning">
                <h4><i class="bi bi-exclamation-triangle"></i> Erreurs rencontr√©es :</h4>
                <ul>
                    {% for erreur in erreurs %}
                        <li>{{ erreur }}</li>
                    {% endfor %}
                </ul>
            </div>
        {% endif %}

        {% if has_data %}
            <div class="stats-card">
                <h3><i class="bi bi-graph-up"></i> Vue d'ensemble de la conformit√© TEG</h3>
                <div class="stats-grid">
                    <div class="stat-item">
                        <span class="stat-value">{{ stats_globales.total_global }}</span>
                        <span class="stat-label">Total enregistrements</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value">{{ stats_globales.total_conformes }}</span>
                        <span class="stat-label">Conformes</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value">{{ stats_globales.total_non_conformes }}</span>
                        <span class="stat-label">Non conformes</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value">{{ stats_globales.taux_conformite }}%</span>
                        <span class="stat-label">Taux de conformit√©</span>
                    </div>
                </div>
                <div class="conformity-indicator">
                    <div class="conformity-bar">
                        <div class="conformity-fill" style="width: {{ stats_globales.percent_conformes }}%">
                            {{ stats_globales.percent_conformes }}%
                        </div>
                    </div>
                </div>
            </div>

            {% if stats_globales.chart_global %}
            <div class="global-chart-container">
                <h3><i class="bi bi-pie-chart"></i> R√©partition globale des conformit√©s</h3>
                <div class="global-chart">
                    <canvas id="chart-global"></canvas>
                </div>
                <div class="stats-summary">
                    <span class="badge bg-success">
                        Conformes: {{ stats_globales.percent_conformes }}% ({{ stats_globales.total_conformes }})
                    </span>
                    <span class="badge bg-danger">
                        Non conformes: {{ stats_globales.percent_non_conformes }}% ({{ stats_globales.total_non_conformes }})
                    </span>
                </div>
            </div>
            {% endif %}

            <h3 class="mt-4 mb-3" style="color: #2c3e50; font-weight: 700;">
                <i class="bi bi-bar-chart"></i> Analyse d√©taill√©e par type de produit
            </h3>
            <div class="row">
                {% for chart in charts %}
                    <div class="col-md-6 col-lg-4 mb-4">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">{{ chart.title }}</h5>
                                <div class="chart-container">
                                    <canvas id="chart-{{ forloop.counter0 }}"></canvas>
                                </div>
                                <div class="mt-3">
                                    <div class="stats-summary">
                                        <span class="badge bg-success">
                                            Conformes: {{ chart.percent_conformes }}% ({{ chart.conformes }})
                                        </span>
                                        <span class="badge bg-danger">
                                            Non conformes: {{ chart.percent_non_conformes }}% ({{ chart.non_conformes }})
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i> Aucune donn√©e TEG disponible pour ce fichier.
            </div>
        {% endif %}
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <script>

        Chart.defaults.font.family = "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif";
        Chart.defaults.plugins.legend.labels.padding = 15;
        Chart.defaults.plugins.legend.labels.usePointStyle = true;
        Chart.defaults.plugins.legend.labels.pointStyle = 'circle';

        const charts = [];

        // Fonction pour convertir les callbacks string en fonctions
        function parseChartCallbacks(chartConfig) {
            if (chartConfig.options && 
                chartConfig.options.plugins && 
                chartConfig.options.plugins.tooltip && 
                chartConfig.options.plugins.tooltip.callbacks) {
                
                const callbacks = chartConfig.options.plugins.tooltip.callbacks;
                
                // Convertir label callback
                if (typeof callbacks.label === 'string') {
                    try {
                        callbacks.label = eval('(' + callbacks.label + ')');
                    } catch (e) {
                        console.error('Erreur parsing label callback:', e);
                    }
                }
                
                // Convertir afterLabel callback
                if (typeof callbacks.afterLabel === 'string') {
                    try {
                        callbacks.afterLabel = eval('(' + callbacks.afterLabel + ')');
                    } catch (e) {
                        console.error('Erreur parsing afterLabel callback:', e);
                    }
                }
                
                // Convertir footer callback
                if (typeof callbacks.footer === 'string') {
                    try {
                        callbacks.footer = eval('(' + callbacks.footer + ')');
                    } catch (e) {
                        console.error('Erreur parsing footer callback:', e);
                    }
                }
            }
            return chartConfig;
        }

        // Fonction pour initialiser un graphique avec tooltips fonctionnels
        function initChart(canvasId, chartData) {
            const ctx = document.getElementById(canvasId);
            if (ctx) {
                try {
                    // Parser les callbacks avant de cr√©er le graphique
                    const parsedData = parseChartCallbacks(chartData);
                    
                    const chart = new Chart(ctx, parsedData);
                    charts.push(chart);
                    
                    console.log(' Graphique cr√©√©:', canvasId);
                    return chart;
                } catch (error) {
                    console.error(' Erreur cr√©ation graphique', canvasId, error);
                }
            } else {
                console.warn(' Canvas non trouv√©:', canvasId);
            }
            return null;
        }

        // Initialiser le graphique global
        {% if stats_globales.chart_global %}
        document.addEventListener('DOMContentLoaded', function() {
            try {
                const globalChartData = {{ stats_globales.chart_global|safe }};
                console.log('üìä Initialisation graphique global');
                initChart('chart-global', globalChartData);
            } catch (error) {
                console.error(' Erreur graphique global:', error);
            }
        });
        {% endif %}

        // Initialiser les graphiques individuels
        {% for chart in charts %}
        document.addEventListener('DOMContentLoaded', function() {
            try {
                const chartData{{ forloop.counter0 }} = {{ chart.chartjs|safe }};
                console.log('üìä Initialisation graphique {{ forloop.counter0 }} ({{ chart.title }})');
                initChart('chart-{{ forloop.counter0 }}', chartData{{ forloop.counter0 }});
            } catch (error) {
                console.error(' Erreur graphique {{ forloop.counter0 }}:', error);
            }
        });
        {% endfor %}

        // Debug: V√©rifier que tous les canvas existent
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üîç V√©rification des canvas:');
            {% if stats_globales.chart_global %}
            const globalCanvas = document.getElementById('chart-global');
            console.log('  - Graphique global:', globalCanvas ? ' Trouv√©' : ' Manquant');
            {% endif %}
            {% for chart in charts %}
            const canvas{{ forloop.counter0 }} = document.getElementById('chart-{{ forloop.counter0 }}');
            console.log('   Graphique {{ forloop.counter0 }} ({{ chart.title }}):', canvas{{ forloop.counter0 }} ? ' Trouv√©' : ' Manquant');
            {% endfor %}
            
            console.log(' Total graphiques √† initialiser:', {{ charts|length }});
        });

        // Ajouter des √©v√©nements de survol personnalis√©s
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                charts.forEach((chart, index) => {
                    if (chart && chart.canvas) {
                        chart.canvas.style.cursor = 'pointer';
                        
                        // √âv√©nement au survol
                        chart.canvas.addEventListener('mousemove', function(evt) {
                            const activePoints = chart.getElementsAtEventForMode(
                                evt,
                                'nearest',
                                { intersect: true },
                                false
                            );
                            
                            if (activePoints.length > 0) {
                                chart.canvas.style.cursor = 'pointer';
                            } else {
                                chart.canvas.style.cursor = 'default';
                            }
                        });
                        
                        console.log(` √âv√©nements interactifs ajout√©s au graphique ${index}`);
                    }
                });
            }, 1000);
        });

        // Fonction pour g√©n√©rer le PDF
        document.getElementById('downloadPdfBtn')?.addEventListener('click', async function() {
            const button = this;
            const spinner = button.querySelector('.spinner-border');
            const originalText = button.innerHTML;
            
            // D√©sactiver le bouton et afficher le spinner
            button.disabled = true;
            spinner.classList.remove('d-none');
            button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> G√©n√©ration du PDF...';
            
            try {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({
                    orientation: 'landscape',
                    unit: 'mm',
                    format: 'a4'
                });

                const pageWidth = pdf.internal.pageSize.getWidth();
                const pageHeight = pdf.internal.pageSize.getHeight();
                const margin = 12;
                
                // R√©cup√©rer les logos
                const logoLeft = document.querySelector('.logo-left img');
                const logoRight = document.querySelector('.logo-right img');
                let logoLeftBase64 = null;
                let logoRightBase64 = null;
                
                try {
                    if (logoLeft) logoLeftBase64 = await getImageBase64(logoLeft);
                    if (logoRight) logoRightBase64 = await getImageBase64(logoRight);
                } catch (error) {
                    console.warn('Impossible de charger les logos:', error);
                }

                // PAGE 1: Vue d'ensemble
                // En-t√™te avec logos
                pdf.setFillColor(44, 62, 80);
                pdf.rect(0, 0, pageWidth, 38, 'F');
                
                // Logo gauche
                if (logoLeftBase64) {
                    pdf.addImage(logoLeftBase64, 'PNG', margin, 5, 25, 25);
                }
                
                // Logo droite
                if (logoRightBase64) {
                    pdf.addImage(logoRightBase64, 'PNG', pageWidth - margin - 25, 5, 25, 25);
                }
                
                // Texte centr√©
                pdf.setTextColor(255, 255, 255);
                pdf.setFontSize(18);
                pdf.setFont(undefined, 'bold');
                pdf.text('Comit√© National √âconomique et Financier (CNEF)', pageWidth / 2, 14, { align: 'center' });
                
                // Ligne s√©paratrice jaune
                pdf.setDrawColor(239, 206, 19);
                pdf.setLineWidth(0.8);
                pdf.line(pageWidth / 2 - 40, 17, pageWidth / 2 + 40, 17);
                
                pdf.setFontSize(14);
                pdf.setTextColor(239, 206, 19);
                pdf.text('Banque des Etats de l\'Afrique Centrale (BEAC)', pageWidth / 2, 23, { align: 'center' });
                
                pdf.setTextColor(255, 255, 255);
                pdf.setFontSize(11);
                pdf.text('Rapport de v√©rification des TEG', pageWidth / 2, 31, { align: 'center' });

                let yPosition = 48;

                // Titre du fichier avec encadr√©
                pdf.setFillColor(239, 206, 19);
                pdf.roundedRect(margin, yPosition - 5, pageWidth - (2 * margin), 10, 2, 2, 'F');
                pdf.setTextColor(44, 62, 80);
                pdf.setFontSize(13);
                pdf.setFont(undefined, 'bold');
                pdf.text('{{ title }}', pageWidth / 2, yPosition + 2, { align: 'center' });
                yPosition += 15;

                // Section statistiques globales - Encadr√©
                pdf.setDrawColor(102, 126, 234);
                pdf.setLineWidth(0.5);
                pdf.roundedRect(margin, yPosition, pageWidth - (2 * margin), 40, 3, 3);
                
                pdf.setFillColor(102, 126, 234);
                pdf.roundedRect(margin, yPosition, pageWidth - (2 * margin), 8, 3, 3, 'F');
                
                pdf.setTextColor(255, 255, 255);
                pdf.setFontSize(12);
                pdf.setFont(undefined, 'bold');
                pdf.text('Vue d\'ensemble de la conformit√© TEG', margin + 5, yPosition + 5.5, );
                
                yPosition += 12;

                // Statistiques en grille
                const statsStartY = yPosition;
                const colWidth = (pageWidth - (2 * margin) - 15) / 4;
                
                const statsData = [
                    { label: 'Total enregistrements', value: '{{ stats_globales.total_global }}', color: [52, 152, 219] },
                    { label: 'Conformes', value: '{{ stats_globales.total_conformes }}', color: [40, 167, 69] },
                    { label: 'Non conformes', value: '{{ stats_globales.total_non_conformes }}', color: [220, 53, 69] },
                    { label: 'Taux de conformit√©', value: '{{ stats_globales.taux_conformite }}%', color: [102, 126, 234] }
                ];

                statsData.forEach((stat, index) => {
                    const xPos = margin + 5 + (index * (colWidth + 5));
                    
                    // Valeur en gros
                    pdf.setTextColor(stat.color[0], stat.color[1], stat.color[2]);
                    pdf.setFontSize(22);
                    pdf.setFont(undefined, 'bold');
                    pdf.text(stat.value, xPos + (colWidth / 2), statsStartY + 8, { align: 'center' });
                    
                    // Label en dessous
                    pdf.setTextColor(80, 80, 80);
                    pdf.setFontSize(9);
                    pdf.setFont(undefined, 'normal');
                    const lines = pdf.splitTextToSize(stat.label, colWidth - 4);
                    pdf.text(lines, xPos + (colWidth / 2), statsStartY + 14, { align: 'center' });
                });

                yPosition += 33;

                // Graphique global centr√©
                {% if stats_globales.chart_global %}
                const globalChartCanvas = document.getElementById('chart-global');
                if (globalChartCanvas) {
                    const globalChartImg = globalChartCanvas.toDataURL('image/png', 1.0);
                    const chartWidth = 100;
                    const chartHeight = 70;
                    const chartX = (pageWidth - chartWidth) / 2;
                    
                    pdf.setFillColor(250, 250, 250);
                    pdf.roundedRect(chartX - 5, yPosition - 5, chartWidth + 10, chartHeight + 20, 3, 3, 'F');
                    
                    pdf.setTextColor(44, 62, 80);
                    pdf.setFontSize(11);
                    pdf.setFont(undefined, 'bold');
                    pdf.text('R√©partition globale des conformit√©s', pageWidth / 2, yPosition, { align: 'center' });
                    
                    pdf.addImage(globalChartImg, 'PNG', chartX, yPosition + 2, chartWidth, chartHeight);
                    
                    // L√©gendes sous le graphique
                    const legendY = yPosition + chartHeight + 8;
                    pdf.setFontSize(9);
                    pdf.setFont(undefined, 'bold');
                    
                    pdf.setFillColor(40, 167, 69);
                    pdf.circle(pageWidth / 2 - 40, legendY, 2, 'F');
                    pdf.setTextColor(40, 167, 69);
                    pdf.text('Conformes: {{ stats_globales.percent_conformes }}% ({{ stats_globales.total_conformes }})', pageWidth / 2 - 35, legendY + 1);
                    
                    pdf.setFillColor(220, 53, 69);
                    pdf.circle(pageWidth / 2 + 20, legendY, 2, 'F');
                    pdf.setTextColor(220, 53, 69);
                    pdf.text('Non conformes: {{ stats_globales.percent_non_conformes }}% ({{ stats_globales.total_non_conformes }})', pageWidth / 2 + 25, legendY + 1);
                }
                {% endif %}

                // PAGE 2: Graphiques d√©taill√©s (tous sur une page)
                pdf.addPage();
                yPosition = margin;
                
                // En-t√™te de page 2
                pdf.setFillColor(44, 62, 80);
                pdf.rect(0, 0, pageWidth, 25, 'F');
                
                if (logoLeftBase64) {
                    pdf.addImage(logoLeftBase64, 'PNG', margin, 3, 18, 18);
                }
                
                if (logoRightBase64) {
                    pdf.addImage(logoRightBase64, 'PNG', pageWidth - margin - 18, 3, 18, 18);
                }
                
                pdf.setTextColor(255, 255, 255);
                pdf.setFontSize(14);
                pdf.setFont(undefined, 'bold');
                pdf.text('Analyse d√©taill√©e par type de produit', pageWidth / 2, 15, { align: 'center' });
                
                yPosition = 32;

                // Disposition des 6 graphiques: 3 colonnes x 2 lignes
                const chartsPerRow = 3;
                const spacing = 8;
                const chartWidth = (pageWidth - (2 * margin) - (spacing * (chartsPerRow - 1))) / chartsPerRow;
                const chartHeight = 50;
                const totalChartHeight = chartHeight + 25; // Hauteur + espace pour titre et stats

                {% for chart in charts %}
                const canvas{{ forloop.counter0 }} = document.getElementById('chart-{{ forloop.counter0 }}');
                if (canvas{{ forloop.counter0 }}) {
                    const imgData{{ forloop.counter0 }} = canvas{{ forloop.counter0 }}.toDataURL('image/png', 1.0);
                    
                    const col = {{ forloop.counter0 }} % chartsPerRow;
                    const row = Math.floor({{ forloop.counter0 }} / chartsPerRow);
                    const xPos = margin + (col * (chartWidth + spacing));
                    const yPos = yPosition + (row * totalChartHeight);

                    // Encadr√© pour chaque graphique
                    pdf.setDrawColor(220, 220, 220);
                    pdf.setLineWidth(0.3);
                    pdf.roundedRect(xPos, yPos, chartWidth, totalChartHeight - 3, 2, 2);
                    
                    // Titre
                    pdf.setFontSize(9);
                    pdf.setFont(undefined, 'bold');
                    pdf.setTextColor(44, 62, 80);
                    const titleLines = pdf.splitTextToSize('{{ chart.title }}', chartWidth - 4);
                    pdf.text(titleLines, xPos + chartWidth / 2, yPos + 5, { align: 'center' });
                    
                    // Graphique
                    const chartY = yPos + (titleLines.length > 1 ? 10 : 8);
                    pdf.addImage(imgData{{ forloop.counter0 }}, 'PNG', xPos + 3, chartY, chartWidth - 6, chartHeight);
                    
                    // Statistiques
                    const statsY = chartY + chartHeight + 5;
                    pdf.setFont(undefined, 'bold');
                    pdf.setFontSize(7);
                    
                    pdf.setTextColor(40, 167, 69);
                    pdf.text('Conformes: {{ chart.percent_conformes }}% ({{ chart.conformes }})', xPos + 3, statsY);
                    
                    pdf.setTextColor(220, 53, 69);
                    pdf.text('Non conformes: {{ chart.percent_non_conformes }}% ({{ chart.non_conformes }})', xPos + 3, statsY + 3.5);
                    
                    pdf.setTextColor(100, 100, 100);
                    //pdf.text('Total: {{ chart.total }} enregistrements', xPos + 3, statsY + 7);
                }
                {% endfor %}

                // Pied de page sur chaque page
                const pageCount = pdf.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    pdf.setPage(i);
                    
                    // Ligne de s√©paration
                    pdf.setDrawColor(200, 200, 200);
                    pdf.setLineWidth(0.3);
                    pdf.line(margin, pageHeight - 12, pageWidth - margin, pageHeight - 12);
                    
                    pdf.setFontSize(8);
                    pdf.setTextColor(120, 120, 120);
                    pdf.text(`Page ${i} / ${pageCount}`, pageWidth / 2, pageHeight - 7, { align: 'center' });
                    pdf.text(`¬®Produit le ${new Date().toLocaleDateString('fr-FR')} √† ${new Date().toLocaleTimeString('fr-FR')}`, pageWidth - margin, pageHeight - 7, { align: 'right' });
                    pdf.text('CNEF - BEAC', margin, pageHeight - 7);
                }

                // T√©l√©charger le PDF
                const fileName = 'Rapport_TEG_{{ fichier.nom_fichier|cut:".xlsx"|cut:".xls" }}_' + new Date().toISOString().slice(0,10) + '.pdf';
                pdf.save(fileName);

            } catch (error) {
                console.error('Erreur lors de la g√©n√©ration du PDF:', error);
                alert('Une erreur est survenue lors de la g√©n√©ration du PDF. Veuillez r√©essayer.');
            } finally {
                // R√©activer le bouton
                button.disabled = false;
                button.innerHTML = originalText;
            }
        });

        // Fonction pour convertir une image en Base64
        async function getImageBase64(imgElement) {
            return new Promise((resolve, reject) => {
                try {
                    // V√©rifier si l'image est d√©j√† charg√©e
                    if (!imgElement.complete) {
                        imgElement.onload = () => convertToBase64(imgElement, resolve, reject);
                        imgElement.onerror = () => reject(new Error('Erreur chargement image'));
                    } else {
                        convertToBase64(imgElement, resolve, reject);
                    }
                } catch (error) {
                    console.error('Erreur conversion image en Base64:', error);
                    reject(error);
                }
            });
        }

        function convertToBase64(imgElement, resolve, reject) {
            try {
                // Cr√©er un canvas temporaire
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // D√©finir les dimensions du canvas
                canvas.width = imgElement.naturalWidth || imgElement.width;
                canvas.height = imgElement.naturalHeight || imgElement.height;
                
                // Dessiner l'image sur le canvas
                ctx.drawImage(imgElement, 0, 0);
                
                // Convertir en Base64
                const base64 = canvas.toDataURL('image/png');
                resolve(base64);
            } catch (error) {
                console.error('Erreur lors de la conversion canvas:', error);
                reject(error);
            }
        }

    </script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
</body>
</html>