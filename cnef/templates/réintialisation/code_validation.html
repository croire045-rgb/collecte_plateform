<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code de validation - CNEF</title>
    {% load static %}
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="{% static 'image/Congo.png' %}">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf1 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .dashboard {
            max-width: 1200px;
            width: 100%;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.08);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1a2634, #2c3e50);
            color: white;
            padding: 30px 40px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 20px;
        }

        .header-center {
            text-align: center;
            flex: 1;
            padding: 0 30px;
        }

        .main-title {
            font-size: 1.7em;
            font-weight: 700;
            color: #ffffff;
            margin-bottom: 12px;
            line-height: 1.3;
        }

        .separator {
            width: 120px;
            height: 3px;
            background: linear-gradient(90deg, transparent, #efce13, transparent);
            margin: 10px auto;
            border-radius: 2px;
        }

        .sub-title {
            font-size: 1.15em;
            color: #efce13;
            font-weight: 600;
        }

        .logo-container {
            background: rgba(255,255,255,0.05);
            padding: 15px;
            border-radius: 12px;
        }

        .header-image {
            height: 90px;
            width: auto;
            object-fit: contain;
        }

        .content-container {
            padding: 50px 40px;
            max-width: 520px;
            margin: 0 auto;
        }

        .form-title {
            text-align: center;
            color: #2c3e50;
            font-size: 1.9em;
            margin-bottom: 12px;
            font-weight: 700;
        }

        .form-subtitle {
            text-align: center;
            color: #7f8c8d;
            font-size: 0.95em;
            margin-bottom: 35px;
            line-height: 1.5;
        }

        .alert {
            padding: 14px 18px;
            border-radius: 8px;
            margin-bottom: 25px;
            font-size: 0.92em;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .alert-error {
            background-color: #fef2f2;
            border-left: 4px solid #e74c3c;
            color: #c0392b;
        }

        .alert-success {
            background-color: #d1f2eb;
            border-left: 4px solid #27ae60;
            color: #186a3b;
        }

        .alert-icon {
            font-size: 1.3em;
            font-weight: bold;
        }

        /* Code Input Box - Design amélioré */
        .code-input-container {
            margin: 35px 0;
            text-align: center;
        }

        .code-input-label {
            display: block;
            margin-bottom: 20px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 1.05em;
        }

        .code-input {
            width: 100%;
            max-width: 350px;
            padding: 20px 25px;
            border: 3px solid #e1e8ed;
            border-radius: 12px;
            font-size: 32px;
            font-weight: bold;
            text-align: center;
            letter-spacing: 12px;
            font-family: 'Courier New', monospace;
            transition: all 0.3s ease;
            background-color: #fafbfc;
            color: #2c3e50;
            text-transform: uppercase;
        }

        .code-input:hover {
            border-color: #cbd5e0;
            background-color: #ffffff;
        }

        .code-input:focus {
            outline: none;
            border-color: #ffc107;
            background-color: white;
            box-shadow: 0 0 0 4px rgba(255, 193, 7, 0.15);
        }

        .code-input.validating {
            border-color: #3498db;
            background-color: #e7f3ff;
        }

        .code-input.success {
            border-color: #27ae60;
            background-color: #d1f2eb;
        }

        .code-input.error {
            border-color: #e74c3c;
            background-color: #fef9f9;
            animation: shake 0.5s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }

        .code-hint {
            margin-top: 12px;
            font-size: 0.9em;
            color: #7f8c8d;
        }

        .code-status {
            margin-top: 15px;
            min-height: 24px;
            font-size: 0.95em;
            font-weight: 600;
        }

        .code-status.validating {
            color: #3498db;
        }

        .code-status.success {
            color: #27ae60;
        }

        .code-status.error {
            color: #e74c3c;
        }

        /* Timer */
        .timer-container {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
            border-radius: 8px;
            padding: 15px;
            margin: 25px 0;
            text-align: center;
        }

        .timer-text {
            color: #856404;
            font-size: 0.95em;
            font-weight: 600;
        }

        .timer {
            font-size: 1.3em;
            font-weight: bold;
            color: #856404;
            margin-top: 5px;
        }

        .buttons-container {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .submit-btn {
            flex: 1;
            background: linear-gradient(135deg, #27ae60, #229954);
            color: white;
            border: none;
            padding: 16px;
            border-radius: 10px;
            font-size: 1.05em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(39, 174, 96, 0.2);
        }

        .submit-btn:hover:not(:disabled) {
            background: linear-gradient(135deg, #229954, #1e8449);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(39, 174, 96, 0.3);
        }

        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .resend-btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.2);
        }

        .resend-btn:hover:not(:disabled) {
            background: linear-gradient(135deg, #2980b9, #2471a3);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.3);
        }

        .footer-note {
            text-align: center;
            padding: 25px 20px;
            background: linear-gradient(135deg, #f8f9fa, #ecf0f1);
            color: #5a6c7d;
            font-size: 0.88em;
            line-height: 1.6;
            border-top: 1px solid #e1e8ed;
        }

        .footer-note strong {
            color: #34495e;
            font-weight: 600;
        }

        .change-email {
            text-align: center;
            margin-top: 20px;
        }

        .change-email a {
            color: #3498db;
            text-decoration: none;
            font-weight: 600;
            font-size: 0.95em;
        }

        .change-email a:hover {
            text-decoration: underline;
        }

        /* Loading spinner */
        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #ffffff;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                padding: 25px 20px;
            }

            .header-image {
                height: 70px;
            }

            .main-title {
                font-size: 1.3em;
            }

            .content-container {
                padding: 35px 25px;
            }

            .code-input {
                font-size: 28px;
                letter-spacing: 8px;
            }
        }
    </style>
</head>

{% load static %}

<body>
    <div class="dashboard">
        <div class="header">
            <div class="logo-container">
                <img src="{% static 'image/Congo.png' %}" alt="République du Congo" class="header-image">
            </div>

            <div class="header-center">
                <div class="main-title">Comité National Économique et Financier<br>(CNEF)</div>
                <hr class="separator">
                <div class="sub-title">Banque des États de l'Afrique Centrale<br>(BEAC)</div>
            </div>

            <div class="logo-container">
                <img src="{% static 'image/BEAC.png' %}" alt="BEAC" class="header-image">
            </div>
        </div>

        <div class="content-container">
            {% block content %}

            <h2 class="form-title">Validation du code</h2>
            <div style="height: 20px;"></div>
         
            <p class="form-subtitle">
                Un code de confirmation a été envoyé à<br>
                <strong>{{ request.session.reset_email }}</strong>
            </p>

            <!-- Timer d'expiration -->
            <div class="timer-container">
                <div class="timer-text"> Code valide pendant</div>
                <div class="timer" id="timer">--:--</div>
            </div>

            <form method="post" id="codeForm">
                {% csrf_token %}
                
                <div class="code-input-container">
                    <label for="code" class="code-input-label">
                        Entrez le code de 6 caractères
                    </label>
                    <input 
                        type="text" 
                        id="code" 
                        name="code" 
                        class="code-input"
                        maxlength="6" 
                        placeholder="------"
                        autocomplete="off"
                        required
                    >
                    <div class="code-hint">
                        Le code contient 5 chiffres et 1 lettre majuscule
                    </div>
                    <div class="code-status" id="codeStatus"></div>
                </div>

                <div class="buttons-container">
                    <button type="submit" class="submit-btn" id="validateBtn">
                        Valider le code
                    </button>
                    <button type="submit" name="resend" value="true" class="submit-btn resend-btn">
                        Renvoyer le code
                    </button>
                </div>
                
                <div class="change-email">
                    <a href="{% url 'saisie_mail' %}">← Changer d'adresse email</a>
                </div>
            </form>

            {% endblock %}
        </div>

        <div class="footer-note">
            <strong>Note importante :</strong> Les comptes sont créés par invitation uniquement.<br>
            Veuillez contacter votre administrateur système pour obtenir vos identifiants d'accès.
        </div>
    </div>

    <script>
        // ============================================
        // VALIDATION AUTOMATIQUE DU CODE
        // ============================================
        
        const codeInput = document.getElementById('code');
        const codeStatus = document.getElementById('codeStatus');
        const validateBtn = document.getElementById('validateBtn');
        const codeForm = document.getElementById('codeForm');
        
        let isValidating = false;
        
        // Fonction pour obtenir le CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        // Validation automatique dès que 6 caractères sont saisis
        codeInput.addEventListener('input', function(e) {
            // Convertir en majuscules automatiquement
            this.value = this.value.toUpperCase();
            
            // Supprimer tous les espaces
            this.value = this.value.replace(/\s/g, '');
            
            // Réinitialiser les états visuels
            codeInput.classList.remove('error', 'success', 'validating');
            codeStatus.className = 'code-status';
            codeStatus.textContent = '';
            
            // Si 6 caractères saisis, valider automatiquement
            if (this.value.length === 6 && !isValidating) {
                validateCodeAjax(this.value);
            }
        });
        
        // Fonction de validation AJAX
        async function validateCodeAjax(code) {
            isValidating = true;
            
            // Afficher l'état de validation
            codeInput.classList.add('validating');
            codeStatus.className = 'code-status validating';
            codeStatus.innerHTML = '<span class="spinner"></span> Vérification...';
            validateBtn.disabled = true;
            
            try {
                const response = await fetch('/code-validation-ajax/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({ code: code })
                });
                
                const data = await response.json();
                
                if (data.valid) {
                    // Code correct ! Redirection automatique
                    codeInput.classList.remove('validating');
                    codeInput.classList.add('success');
                    codeStatus.className = 'code-status success';
                    codeStatus.textContent = '✓ Code correct ! Redirection...';
                    
                    // Attendre 1 seconde puis rediriger
                    setTimeout(() => {
                        window.location.href = data.redirect || '/confirmation/';
                    }, 1000);
                    
                } else {
                    // Code incorrect
                    codeInput.classList.remove('validating');
                    codeInput.classList.add('error');
                    codeStatus.className = 'code-status error';
                    
                    if (data.remaining !== undefined) {
                        codeStatus.textContent = `✗ ${data.error}`;
                    } else if (data.redirect) {
                        codeStatus.textContent = `✗ ${data.error}`;
                        setTimeout(() => {
                            window.location.href = data.redirect;
                        }, 2000);
                    } else {
                        codeStatus.textContent = `✗ ${data.error || 'Code incorrect'}`;
                    }
                    
                    // Vider le champ après 1 seconde
                    setTimeout(() => {
                        codeInput.value = '';
                        codeInput.classList.remove('error');
                        codeStatus.textContent = '';
                    }, 2000);
                    
                    validateBtn.disabled = false;
                    isValidating = false;
                }
                
            } catch (error) {
                console.error('Erreur validation:', error);
                codeInput.classList.remove('validating');
                codeInput.classList.add('error');
                codeStatus.className = 'code-status error';
                codeStatus.textContent = '✗ Erreur de connexion';
                
                validateBtn.disabled = false;
                isValidating = false;
            }
        }
        
        // Empêcher la soumission classique si validation en cours
        codeForm.addEventListener('submit', function(e) {
            if (isValidating) {
                e.preventDefault();
                return false;
            }
            
            // Si le bouton "Renvoyer" n'est pas cliqué
            if (!e.submitter || e.submitter.name !== 'resend') {
                // Vérifier que le code a 6 caractères
                if (codeInput.value.length !== 6) {
                    e.preventDefault();
                    codeStatus.className = 'code-status error';
                    codeStatus.textContent = '✗ Le code doit contenir 6 caractères';
                    return false;
                }
            }
        });
        
        // ============================================
        // TIMER D'EXPIRATION (15 MINUTES)
        // ============================================
        
        function startTimer() {
            const timerElement = document.getElementById('timer');
            
            // Récupérer le temps d'envoi du code depuis le serveur
            // On calcule 15 minutes à partir de maintenant
            const expirationTime = new Date().getTime() + (15 * 60 * 1000);
            
            const timerInterval = setInterval(() => {
                const now = new Date().getTime();
                const distance = expirationTime - now;
                
                if (distance < 0) {
                    clearInterval(timerInterval);
                    timerElement.textContent = "EXPIRÉ";
                    timerElement.style.color = "#e74c3c";
                    
                    // Afficher un message
                    codeStatus.className = 'code-status error';
                    codeStatus.textContent = 'Le code a expiré. Veuillez en demander un nouveau.';
                    
                    // Désactiver le champ
                    codeInput.disabled = true;
                    validateBtn.disabled = true;
                } else {
                    const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                    
                    timerElement.textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
                    
                    // Changer la couleur si moins de 2 minutes
                    if (minutes < 2) {
                        timerElement.style.color = "#e74c3c";
                    }
                }
            }, 1000);
        }
        
        // Démarrer le timer au chargement
        startTimer();
        
        // Focus automatique sur le champ
        window.addEventListener('load', () => {
            codeInput.focus();
        });
    </script>

</body>
</html>